{% extends 'game/base.html.twig' %}

{% block title %}Étape {{ step }}{% endblock %}

{% block body %}
<div class="step-page"
     data-controller="step-controls game-sync"
     data-game-sync-url-value="{{ path('game_status') }}"
     data-game-sync-mercure-url-value="{{ mercure_public_url }}"
     data-game-sync-topic-value="{{ escape_id ? '/escape/' ~ escape_id ~ '/status' : '' }}"
     data-game-sync-finished-redirect-url-value="{{ path('game_waiting') }}"
     data-game-sync-inactive-redirect-url-value="{{ path('game_waiting') }}">
    <header>
        <div>
            <h1>Étape {{ step }}</h1>
            {#  <p class="hint">Équipe {{ team_code }} • Étape en cours : {{ current_step }}</p> #}
        </div>
        <span class="badge">{{ team_code }}</span>
    </header>

    <div class="card stack"
         data-controller="{% if step == 'E' %}game team-sync{% else %}game{% endif %}"
         data-game-endpoint-value="{{ path('game_validate') }}"
            {% if step == 'E' and team_payload %}
        data-team-sync-url-value="{{ path('game_team_state') }}"
        data-team-sync-mercure-url-value="{{ mercure_public_url }}"
        data-team-sync-topic-value="/escape/{{ team_payload.escape_id }}/team/{{ team_payload.id }}/state"
        data-team-sync-current-updated-value="{{ team_payload.updated_at }}"
            {% endif %}>
        <div class="status">Suivez les instructions de l'animateur pour cette étape.</div>
        <p class="hint">Lorsque vous avez trouvé la lettre, validez pour passer à l'étape suivante.</p>

        {% if error %}
            <div class="status closed" data-game-status-target>{{ error }}</div>
        {% endif %}

        {% if step == 'E' %}
            <div class="status">
                Pour trouver la dernière lettre suivez maintenant la piste des QR code. Commencez par scanner le premier
                qui est sur votre table, et suivez ainsi la piste jusqu'au dernier QR code qui vous révèlera la lettre à
                inscrire  inscrire. Note : suivez les QR code dans l'ordre, et uniquement ceux qui portent le code :
                "{{ team_code }}".
            </div>
            <div class="status">
                QR déjà scannés :
                {{ scanned_qr_codes is not empty ? scanned_qr_codes|join(', ') : 'Aucun pour le moment.' }}
            </div>
            {% if progress['E'] is defined and progress['E'].completed %}
                <div class="status">Séquence terminée. Vous pouvez passer à l'étape F.</div>
                <a class="btn" href="{{ path('game_final') }}">Accéder à l'étape finale</a>
            {% else %}
                <div class="hint">Scannez chaque QR code pour faire avancer la séquence.</div>
            {% endif %}
        {% endif %}

        {% if step in ['A', 'B', 'C', 'D'] %}
            <form method="post" class="form_step" data-game-target="form" data-action="submit->game#validate" data-turbo="false">
                <input type="hidden" value="{{ step }}" data-game-target="step">
                <label>
                    {#  <span class="hint">Lettre attendue</span> #}
                    <input class="input" type="text" placeholder="Lettre attendue..." name="letter" maxlength="1" required data-game-target="input">
                </label>
                <button class="btn" type="submit">Valider l'étape {{ step }}</button>
            </form>
            {% if not error %}
                <div class="status closed" data-game-status-target></div>
            {% endif %}
        {% endif %}
    </div>

    {#  <div class="card">
        <h2>Progression</h2>
        <div class="progress">
            {% for label, data in progress %}
                <span class="{% if data.completed %}completed{% endif %}">
                {{ label }}{% if data.completed %} ✓{% endif %}
            </span>
            {% endfor %}
        </div>
    </div>
    #}

        <div class="card">
            <h2>Progression</h2>

            <ol class="stepper" aria-label="Progression">
                {% for label, data in progress %}
                    {% set stepIndex = loop.index %}

                    <li class="stepper__item {% if data.completed %}is-complete{% endif %}"
                        data-step="{{ stepIndex }}"
                        aria-current="{% if data.completed and loop.last %}step{% endif %}">
                        <span class="stepper__dot" aria-hidden="true">{{ stepIndex }}</span>
                        {# Optionnel : afficher le label sous la barre (si tu veux) #}
                        {# <span class="stepper__label">{{ label }}</span> #}
                    </li>
                {% endfor %}
            </ol>
        </div>

{% endblock %}