{% extends 'game/base.html.twig' %}

{% block title %}Étape {{ step }}{% endblock %}

{% block body %}
<div class="step-page"
     data-controller="step-controls game-sync"
     data-game-sync-url-value="{{ path('game_status') }}"
     data-game-sync-mercure-url-value="{{ mercure_public_url }}"
     data-game-sync-topic-value="{{ escape_id ? '/escape/' ~ escape_id ~ '/status' : '' }}"
     data-game-sync-finished-redirect-url-value="{{ path('game_waiting') }}"
     data-game-sync-inactive-redirect-url-value="{{ path('game_waiting') }}">
    <header>
        <div>
            <h1>Étape {{ step }}</h1>
            {#  <p class="hint">Équipe {{ team_code }} • Étape en cours : {{ current_step }}</p> #}
        </div>
        <span class="badge">{{ team_code }}</span>
    </header>

    <div class="card stack"
         data-controller="{% if step == 'E' %}game team-sync{% else %}game{% endif %}"
         data-game-endpoint-value="{{ path('game_validate') }}"
            {% if step == 'E' and team_payload %}
        data-team-sync-url-value="{{ path('game_team_state') }}"
        data-team-sync-mercure-url-value="{{ mercure_public_url }}"
        data-team-sync-topic-value="/escape/{{ team_payload.escape_id }}/team/{{ team_payload.id }}/state"
        data-team-sync-current-updated-value="{{ team_payload.updated_at }}"
            {% endif %}>

        {% if step in ['A', 'B', 'C', 'D'] %}
        <div class="status">Entrez la lettre trouvée et validez pour passer à l'étape suivante.</div>
       {# <p class="hint">Lorsque vous avez trouvé la lettre, validez pour passer à l'étape suivante.</p>  #}
        {% endif %}

        {% if error %}
            <div class="status closed" data-game-target="status">{{ error }}</div>
        {% endif %}

        {% if step == 'E' %}
            <div class="status">
                Pour découvrir la dernière lettre, suivez la piste des QR codes.
                Commencez par scanner celui posé sur votre table, puis enchaînez les suivants dans l’ordre, jusqu’au dernier.
                ⚠️ Ne scannez que les QR codes portant le code de votre équipe :"{{ team_code }}". Les QR codes doivent être scannés dans l’ordre.
                Un QR trop tôt… et la piste restera muette.
            </div>
            {% if team_payload %}
                <div class="status">
                    PIN éphémère :
                    <strong data-team-sync-target="pin">{{ team_payload.pin }}</strong>
                </div>
            {% endif %}
            <div class="status">
                Sur la piste des qr code, le premier est sur votre table.<br>Indices suivants :
                {% if scanned_qr_details is not empty %}
                    <ul>
                        {% for item in scanned_qr_details %}
                          {#   <li><strong>{{ item.code }}</strong> — {{ item.message ?: 'Indice non renseigné.' }}</li> #}
                            <li><strong> {{ item.message ?: 'parcours terminé.' }}</li>
                        {% endfor %}
                    </ul>
                {% else %}
                    Aucun pour le moment.
                {% endif %}
            </div>
            {% if progress['E'] is defined and progress['E'].completed %}
                <div class="status">Séquence terminée. Cap sur l’étape F.</div>
                <a class="btn final_step" href="{{ path('game_final') }}">Accéder à l'étape finale</a>
           {#  {% else %}
                <div class="hint">Scannez chaque QR code pour faire avancer la séquence.</div>#}
            {% endif %}
        {% endif %}

        {% if step in ['A', 'B', 'C', 'D'] %}
            <form method="post" class="form_step" data-game-target="form" data-action="submit->game#validate" data-turbo="false">
                <input type="hidden" value="{{ step }}" data-game-target="step">
                <label>
                    {#  <span class="hint">Lettre attendue</span> #}
                    <input class="input" type="text" placeholder="Lettre attendue..." name="letter" maxlength="1" required data-game-target="input">
                </label>
                <button class="btn" type="submit">Valider l'étape {{ step }}</button>
            </form>
            {% if not error %}
                <div class="status closed" data-game-target="status"></div>
            {% endif %}
        {% endif %}
    </div>

         <div class="card_progress">
            <h2>Progression</h2>

            <ol class="stepper" aria-label="Progression">
                {% for label, data in progress %}
                    {% set stepIndex = loop.index %}

                    <li class="stepper__item {% if data.completed %}is-complete{% endif %}"
                        data-step="{{ stepIndex }}"
                        aria-current="{% if data.completed and loop.last %}step{% endif %}">
                        <span class="stepper__dot" aria-hidden="true">{{ stepIndex }}</span>
                        {# Optionnel : afficher le label sous la barre (si tu veux) #}
                        {# <span class="stepper__label">{{ label }}</span> #}
                    </li>
                {% endfor %}
            </ol>
        </div>

{% endblock %}